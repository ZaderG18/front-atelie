generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

////////////////////////////////////////////////////////////
// 1. ENUMS GLOBAIS
////////////////////////////////////////////////////////////

enum UserRole {
  ADMIN
  EMPLOYEE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELED
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  CASH
}

enum OrderOrigin {
  WHATSAPP
  INSTAGRAM
  SITE
  BALCAO
  IFOOD
  TELEFONE
}

enum TransactionType {
  ENTRADA
  SAIDA
}

enum StockMovementType {
  IN
  OUT
}

enum FlavorType {
  FILLING
  DOUGH
}

enum WeekDay {
  seg
  ter
  qua
  qui
  sex
  sab
  dom
}

////////////////////////////////////////////////////////////
// 2. USUÁRIOS E CLIENTES
////////////////////////////////////////////////////////////

model User {
  id             Int             @id @default(autoincrement())
  name           String
  email          String          @unique
  password       String
  role           UserRole        @default(ADMIN)
  
  stockMovements StockMovement[]
  transactions   Transaction[]   // <--- ADICIONADO: Para saber quem lançou a conta

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("users")
}

model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  email     String?
  address   String?
  birthday  DateTime?
  notes     String?
  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

////////////////////////////////////////////////////////////
// 3. ESTOQUE E INSUMOS
////////////////////////////////////////////////////////////

model Ingredient {
  id            Int             @id @default(autoincrement())
  name          String
  unit          String
  costPrice     Decimal         @db.Decimal(10, 2)
  stockQuantity Decimal         @db.Decimal(10, 2)
  minStockAlert Decimal         @db.Decimal(10, 2)
  updatedAt     DateTime        @updatedAt
  products      ProductRecipe[]
  movements     StockMovement[]

  @@map("ingredients")
}

model ProductRecipe {
  id           Int     @id @default(autoincrement())
  productId    Int
  ingredientId Int
  quantity     Decimal @db.Decimal(10, 3)

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id])

  @@index([productId])
  @@map("product_recipes")
}

////////////////////////////////////////////////////////////
// 4. CATÁLOGO
////////////////////////////////////////////////////////////

model Category {
  id       Int       @id @default(autoincrement())
  name     String
  products Product[]

  @@map("categories")
}

model Product {
  id            Int     @id @default(autoincrement())
  categoryId    Int?
  name          String
  description   String?
  basePrice     Decimal @db.Decimal(10, 2)
  imageUrl      String?
  isMadeToOrder Boolean @default(false)
  isActive      Boolean @default(true)

  category   Category?       @relation(fields: [categoryId], references: [id])
  sizes      ProductSize[]
  flavors    ProductFlavor[]
  extras     ProductExtra[]
  recipe     ProductRecipe[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

model ProductSize {
  id         Int     @id @default(autoincrement())
  productId  Int
  name       String
  priceAddon Decimal @default(0) @db.Decimal(10, 2)

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([productId])
  @@map("product_sizes")
}

model ProductFlavor {
  id         Int        @id @default(autoincrement())
  productId  Int
  name       String
  type       FlavorType
  priceAddon Decimal    @default(0) @db.Decimal(10, 2)

  product           Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItemsFilling OrderItem[] @relation("FillingRelation")
  orderItemsDough   OrderItem[] @relation("DoughRelation")

  @@index([productId])
  @@map("product_flavors")
}

model ProductExtra {
  id        Int     @id @default(autoincrement())
  productId Int
  name      String
  price     Decimal @db.Decimal(10, 2)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_extras")
}

////////////////////////////////////////////////////////////
// 5. PEDIDOS
////////////////////////////////////////////////////////////

model Order {
  id              Int           @id @default(autoincrement())
  customerId      Int?
  customerName    String
  status          OrderStatus   @default(PENDING)
  totalAmount     Decimal       @db.Decimal(10, 2)
  origin          OrderOrigin   @default(BALCAO)
  paymentMethod   PaymentMethod @default(PIX)
  deliveryDate    DateTime?
  deliveryAddress String?
  deliveryFee     Decimal       @default(0) @db.Decimal(10, 2)
  notes           String?

  customer       Customer?       @relation(fields: [customerId], references: [id])
  items          OrderItem[]
  stockMovements StockMovement[]
  transactions   Transaction[]   // <--- ADICIONADO: Oposto da relação com Transaction

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([customerId])
  @@map("orders")
}

model OrderItem {
  id          Int     @id @default(autoincrement())
  orderId     Int
  productId   Int
  productName String
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  totalPrice  Decimal @db.Decimal(10, 2)
  sizeId      Int?
  doughId     Int?
  fillingId   Int?
  observation String?

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  size    ProductSize?   @relation(fields: [sizeId], references: [id])
  dough   ProductFlavor? @relation("DoughRelation", fields: [doughId], references: [id])
  filling ProductFlavor? @relation("FillingRelation", fields: [fillingId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

////////////////////////////////////////////////////////////
// 6. FINANCEIRO
////////////////////////////////////////////////////////////

model Transaction {
  id          Int             @id @default(autoincrement())
  description String
  amount      Decimal         @db.Decimal(10, 2)
  type        TransactionType
  category    String
  date        DateTime

  // Relacionamento com Pedido
  orderId     Int?
  order       Order?          @relation(fields: [orderId], references: [id])

  // Relacionamento com Usuário (Quem lançou?)
  userId      Int?
  user        User?           @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@map("transactions")
}

////////////////////////////////////////////////////////////
// 7. MOVIMENTAÇÕES DE ESTOQUE
////////////////////////////////////////////////////////////

model StockMovement {
  id           Int               @id @default(autoincrement())
  ingredientId Int
  orderId      Int?
  type         StockMovementType
  quantity     Decimal           @db.Decimal(10, 3)
  costPrice    Decimal?          @db.Decimal(10, 2)
  reason       String?
  userId       Int?

  ingredient Ingredient @relation(fields: [ingredientId], references: [id])
  order      Order?     @relation(fields: [orderId], references: [id])
  user       User?      @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([ingredientId])
  @@map("stock_movements")
}

////////////////////////////////////////////////////////////
// 8. CONFIGURAÇÕES DA LOJA (SINGLETON)
////////////////////////////////////////////////////////////

model StoreSettings {
  id              Int       @id @default(autoincrement())
  nomeConfeitaria String    @default("Ateliê Aflorar")
  logoUrl         String?
  telefone        String?
  whatsapp        String?
  descricao       String?
  endereco        String?

  lojaAberta        Boolean   @default(true)
  horaAbertura      String    @default("08:00")
  horaFechamento    String    @default("18:00")
  diasFuncionamento WeekDay[]
  tempoPreparo      String    @default("2-3 dias")
  aceitaEncomendas  Boolean   @default(true)

  aceitaPix      Boolean @default(true)
  chavePix       String?
  tipoChavePix   String?
  aceitaCartao   Boolean @default(true)
  aceitaDinheiro Boolean @default(true)

  tipoTaxaEntrega String  @default("fixa")
  taxaFixa        Decimal @default(10.00) @db.Decimal(10, 2)
  freteGratis     Decimal @default(0) @db.Decimal(10, 2)
  retiradaLocal   Boolean @default(true)

  bairros   DeliveryNeighborhood[]
  updatedAt DateTime               @updatedAt

  @@map("store_settings")
}

model DeliveryNeighborhood {
  id         Int     @id @default(autoincrement())
  settingsId Int
  nome       String
  taxa       Decimal @db.Decimal(10, 2)

  settings StoreSettings @relation(fields: [settingsId], references: [id])

  @@map("delivery_neighborhoods")
}